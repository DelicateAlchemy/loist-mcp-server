<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ metadata.Product.Title }} by {{ metadata.Product.Artist }} - Loist Music Library</title>
    
    <!-- oEmbed Discovery -->
    <link rel="alternate" type="application/json+oembed" 
          href="https://loist.io/oembed?url=https://loist.io/embed/{{ audio_id }}&format=json" 
          title="{{ metadata.Product.Title }}" />
    
    <!-- Enhanced Open Graph Meta Tags -->
    <meta property="og:type" content="music.song" />
    <meta property="og:title" content="{{ metadata.Product.Title }} by {{ metadata.Product.Artist }}" />
    <meta property="og:description" content="Listen to {{ metadata.Product.Title }} by {{ metadata.Product.Artist }}{% if metadata.Product.Album %} from the album {{ metadata.Product.Album }}{% endif %} on Loist Music Library" />
    <meta property="og:audio" content="{{ stream_url }}" />
    <meta property="og:audio:type" content="{{ mime_type }}" />
    <meta property="og:audio:title" content="{{ metadata.Product.Title }}" />
    <meta property="og:audio:artist" content="{{ metadata.Product.Artist }}" />
    {% if metadata.Product.Album %}
    <meta property="og:audio:album" content="{{ metadata.Product.Album }}" />
    {% endif %}
    {% if thumbnail_url %}
    <meta property="og:image" content="{{ thumbnail_url }}" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content="Album artwork for {{ metadata.Product.Title }} by {{ metadata.Product.Artist }}" />
    {% endif %}
    <meta property="og:url" content="https://loist.io/embed/{{ audio_id }}" />
    <meta property="og:site_name" content="Loist Music Library" />
    <meta property="og:locale" content="en_US" />
    
    <!-- Enhanced Twitter Card Meta Tags -->
    <meta name="twitter:card" content="player" />
    <meta name="twitter:site" content="@loistmusic" />
    <meta name="twitter:creator" content="@loistmusic" />
    <meta name="twitter:title" content="{{ metadata.Product.Title }} by {{ metadata.Product.Artist }}" />
    <meta name="twitter:description" content="Listen to {{ metadata.Product.Title }} by {{ metadata.Product.Artist }}{% if metadata.Product.Album %} from the album {{ metadata.Product.Album }}{% endif %}" />
    {% if thumbnail_url %}
    <meta name="twitter:image" content="{{ thumbnail_url }}" />
    <meta name="twitter:image:alt" content="Album artwork for {{ metadata.Product.Title }} by {{ metadata.Product.Artist }}" />
    {% endif %}
    <meta name="twitter:player" content="https://loist.io/embed/{{ audio_id }}" />
    <meta name="twitter:player:width" content="500" />
    <meta name="twitter:player:height" content="200" />
    <meta name="twitter:player:stream" content="{{ stream_url }}" />
    <meta name="twitter:player:stream:content_type" content="{{ mime_type }}" />
    
    <!-- Additional Meta Tags for Better SEO and Social Sharing -->
    <meta name="description" content="Listen to {{ metadata.Product.Title }} by {{ metadata.Product.Artist }}{% if metadata.Product.Album %} from the album {{ metadata.Product.Album }}{% endif %} on Loist Music Library" />
    <meta name="keywords" content="music, audio, {{ metadata.Product.Artist }}, {{ metadata.Product.Title }}{% if metadata.Product.Album %}, {{ metadata.Product.Album }}{% endif %}, streaming, loist" />
    <meta name="author" content="Loist Music Library" />
    <meta name="robots" content="index, follow" />
    
    <!-- Schema.org JSON-LD for Rich Snippets -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "MusicRecording",
        "name": "{{ metadata.Product.Title }}",
        "byArtist": {
            "@type": "MusicGroup",
            "name": "{{ metadata.Product.Artist }}"
        },
        {% if metadata.Product.Album %}
        "inAlbum": {
            "@type": "MusicAlbum",
            "name": "{{ metadata.Product.Album }}"
        },
        {% endif %}
        {% if metadata.Product.Year %}
        "datePublished": "{{ metadata.Product.Year }}",
        {% endif %}
        "audio": {
            "@type": "AudioObject",
            "contentUrl": "{{ stream_url }}",
            "encodingFormat": "{{ mime_type }}"
        },
        {% if thumbnail_url %}
        "image": "{{ thumbnail_url }}",
        {% endif %}
        "url": "https://loist.io/embed/{{ audio_id }}",
        "publisher": {
            "@type": "Organization",
            "name": "Loist Music Library",
            "url": "https://loist.io"
        }
    }
    </script>
    
    <!-- Security Headers (for iframe embedding) -->
    <meta http-equiv="X-Frame-Options" content="ALLOWALL" />
    
    <!-- Styles -->
    <style>
        :root {
            --primary-color: #4A90E2;
            --primary-hover: #357ABD;
            --background: #FFFFFF;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-tertiary: #999999;
            --border-color: #E0E0E0;
            --shadow: rgba(0, 0, 0, 0.1);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        .player-container {
            max-width: 500px;
            margin: 20px auto;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px var(--shadow);
            background-color: var(--background);
        }
        
        .player-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .artwork {
            width: 80px;
            height: 80px;
            min-width: 80px;
            border-radius: 8px;
            background-color: var(--border-color);
            background-size: cover;
            background-position: center;
            margin-right: 16px;
            box-shadow: 0 2px 8px var(--shadow);
        }
        
        .metadata {
            flex: 1;
            overflow: hidden;
        }
        
        .title {
            font-size: 18px;
            font-weight: 600;
            margin: 0 0 4px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .artist {
            font-size: 14px;
            color: var(--text-secondary);
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .album {
            font-size: 12px;
            color: var(--text-tertiary);
            margin: 4px 0 0 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .controls-container {
            margin-top: 16px;
        }
        
        .progress-section {
            margin-bottom: 12px;
        }
        
        .progress-container {
            width: 100%;
            height: 6px;
            background-color: var(--border-color);
            border-radius: 3px;
            position: relative;
            cursor: pointer;
            margin-bottom: 8px;
        }
        
        .progress-container:hover {
            height: 8px;
            margin-top: -1px;
        }
        
        .progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s ease;
        }
        
        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-tertiary);
            font-variant-numeric: tabular-nums;
        }
        
        .playback-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .play-button {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }
        
        .play-button:hover {
            background-color: var(--primary-hover);
            transform: scale(1.05);
        }
        
        .play-button:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }
        
        .play-button:active {
            transform: scale(0.95);
        }
        
        .volume-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .social-sharing {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .share-button {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .share-button:hover {
            color: var(--primary-color);
            background-color: rgba(74, 144, 226, 0.1);
        }
        
        .share-button:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }
        
        .share-menu {
            position: absolute;
            bottom: 100%;
            right: 0;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 20px var(--shadow);
            padding: 8px 0;
            min-width: 160px;
            z-index: 1000;
        }
        
        .share-option {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            padding: 8px 16px;
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 14px;
            text-align: left;
            transition: background-color 0.2s ease;
        }
        
        .share-option:hover {
            background-color: var(--border-color);
        }
        
        .share-option:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: -2px;
        }
        
        .volume-button {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .volume-button:hover {
            color: var(--primary-color);
        }
        
        .volume-slider {
            width: 80px;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--border-color);
            border-radius: 2px;
            outline: none;
        }
        
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
        }
        
        .volume-slider::-moz-range-thumb {
            width: 12px;
            height: 12px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
        
        .format-badge {
            display: inline-block;
            padding: 2px 8px;
            background-color: var(--border-color);
            color: var(--text-secondary);
            font-size: 10px;
            font-weight: 600;
            border-radius: 3px;
            text-transform: uppercase;
            margin-left: 8px;
        }
        
        /* Loading state */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        /* Error state */
        .error-message {
            background-color: #FEE;
            color: #C33;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            margin-top: 16px;
            font-size: 14px;
        }
        
        /* Responsive adjustments */
        @media (max-width: 480px) {
            .player-container {
                margin: 0;
                padding: 16px;
                border-radius: 0;
                box-shadow: none;
            }
            
            .artwork {
                width: 60px;
                height: 60px;
                min-width: 60px;
            }
            
            .title {
                font-size: 16px;
            }
            
            .artist {
                font-size: 13px;
            }
            
            .album {
                display: none; /* Hide on small screens */
            }
            
            .volume-container {
                display: none; /* Volume via device controls on mobile */
            }
        }
        
        /* Accessibility - visible focus indicators */
        button:focus-visible,
        input:focus-visible,
        .progress-container:focus-visible {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }
        
        /* Hidden but accessible */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
    </style>
</head>
<body>
    <div class="player-container" role="region" aria-label="Audio player">
        <div class="player-header">
            {% if thumbnail_url %}
            <div class="artwork" 
                 style="background-image: url('{{ thumbnail_url }}');"
                 role="img"
                 aria-label="Album artwork"></div>
            {% else %}
            <div class="artwork" role="img" aria-label="No artwork available">
                <!-- Default artwork placeholder -->
                <svg width="80" height="80" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect width="80" height="80" fill="#E0E0E0"/>
                    <path d="M40 20C34.5 20 30 24.5 30 30V50C30 55.5 34.5 60 40 60C45.5 60 50 55.5 50 50V30C50 24.5 45.5 20 40 20ZM45 50C45 52.8 42.8 55 40 55C37.2 55 35 52.8 35 50V30C35 27.2 37.2 25 40 25C42.8 25 45 27.2 45 30V50Z" fill="#999"/>
                </svg>
            </div>
            {% endif %}
            <div class="metadata">
                <h1 class="title">{{ metadata.Product.Title }}</h1>
                <p class="artist">{{ metadata.Product.Artist }}</p>
                {% if metadata.Product.Album %}
                <p class="album">{{ metadata.Product.Album }} â€¢ {{ metadata.Product.Year or 'Unknown' }}</p>
                {% endif %}
                <span class="format-badge">{{ metadata.Format.Format }}</span>
            </div>
        </div>
        
        <!-- HTML5 Audio Element (hidden, controlled by custom UI) -->
        <audio id="audio-player" preload="metadata" style="display: none;">
            <source src="{{ stream_url }}" type="{{ mime_type }}">
            Your browser does not support the audio element.
        </audio>
        
        <div class="controls-container">
            <div class="progress-section">
                <div id="progress-container" 
                     class="progress-container" 
                     role="slider"
                     aria-label="Seek"
                     aria-valuemin="0"
                     aria-valuemax="100"
                     aria-valuenow="0"
                     tabindex="0">
                    <div id="progress-bar" class="progress-bar"></div>
                </div>
                <div class="time-display">
                    <span id="current-time" aria-live="polite">0:00</span>
                    <span id="duration">{{ duration_formatted }}</span>
                </div>
            </div>
            
            <div class="playback-controls">
                <button id="play-button" 
                        class="play-button" 
                        aria-label="Play"
                        title="Play/Pause (Space)">
                    <!-- Play Icon (SVG) -->
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                </button>
                
                <div class="volume-container">
                    <button id="mute-button" 
                            class="volume-button" 
                            aria-label="Mute"
                            title="Mute/Unmute (M)">
                        <!-- Volume Icon (SVG) -->
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/>
                        </svg>
                    </button>
                    <input id="volume-slider" 
                           class="volume-slider" 
                           type="range" 
                           min="0" 
                           max="1" 
                           step="0.01" 
                           value="1"
                           aria-label="Volume"
                           title="Volume">
                    <span class="sr-only" id="volume-percentage" aria-live="polite">100%</span>
                </div>
                
                <!-- Social Sharing Buttons -->
                <div class="social-sharing">
                    <button id="share-button" 
                            class="share-button" 
                            aria-label="Share"
                            title="Share this track">
                        <!-- Share Icon (SVG) -->
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
                        </svg>
                    </button>
                    <div id="share-menu" class="share-menu" style="display: none;" role="menu" aria-label="Share options">
                        <button class="share-option" data-platform="twitter" aria-label="Share on Twitter">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
                            </svg>
                            Twitter
                        </button>
                        <button class="share-option" data-platform="facebook" aria-label="Share on Facebook">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                            </svg>
                            Facebook
                        </button>
                        <button class="share-option" data-platform="linkedin" aria-label="Share on LinkedIn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                            </svg>
                            LinkedIn
                        </button>
                        <button class="share-option" data-platform="copy" aria-label="Copy link">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                            </svg>
                            Copy Link
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Error message container -->
        <div id="error-message" class="error-message" style="display: none;" role="alert"></div>
    </div>
    
    <!-- JavaScript for Player Controls -->
    <script>
        (function() {
            'use strict';
            
            // Elements
            const audioPlayer = document.getElementById('audio-player');
            const playButton = document.getElementById('play-button');
            const muteButton = document.getElementById('mute-button');
            const progressBar = document.getElementById('progress-bar');
            const progressContainer = document.getElementById('progress-container');
            const currentTimeDisplay = document.getElementById('current-time');
            const volumeSlider = document.getElementById('volume-slider');
            const volumePercentage = document.getElementById('volume-percentage');
            const errorMessage = document.getElementById('error-message');
            
            // SVG Icons
            const playIcon = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
            const pauseIcon = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';
            const volumeOnIcon = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>';
            const volumeOffIcon = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>';
            
            let isSeeking = false;
            
            // Format time (seconds to MM:SS)
            function formatTime(seconds) {
                if (!isFinite(seconds)) return '0:00';
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60).toString().padStart(2, '0');
                return `${mins}:${secs}`;
            }
            
            // Play/Pause functionality
            playButton.addEventListener('click', function() {
                togglePlayPause();
            });
            
            function togglePlayPause() {
                if (audioPlayer.paused) {
                    audioPlayer.play().catch(function(error) {
                        showError('Playback failed: ' + error.message);
                    });
                    playButton.innerHTML = pauseIcon;
                    playButton.setAttribute('aria-label', 'Pause');
                } else {
                    audioPlayer.pause();
                    playButton.innerHTML = playIcon;
                    playButton.setAttribute('aria-label', 'Play');
                }
            }
            
            // Update progress bar and time
            audioPlayer.addEventListener('timeupdate', function() {
                if (!isSeeking) {
                    const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                    progressBar.style.width = progress + '%';
                    progressContainer.setAttribute('aria-valuenow', Math.round(progress));
                    currentTimeDisplay.textContent = formatTime(audioPlayer.currentTime);
                }
            });
            
            // Update duration when metadata loads
            audioPlayer.addEventListener('loadedmetadata', function() {
                const durationElement = document.getElementById('duration');
                if (durationElement) {
                    durationElement.textContent = formatTime(audioPlayer.duration);
                }
            });
            
            // Seek functionality (mouse/touch)
            progressContainer.addEventListener('click', function(e) {
                seek(e);
            });
            
            progressContainer.addEventListener('mousedown', function() {
                isSeeking = true;
            });
            
            document.addEventListener('mouseup', function() {
                isSeeking = false;
            });
            
            progressContainer.addEventListener('mousemove', function(e) {
                if (isSeeking) {
                    seek(e);
                }
            });
            
            function seek(e) {
                const rect = progressContainer.getBoundingClientRect();
                const pos = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
                audioPlayer.currentTime = pos * audioPlayer.duration;
            }
            
            // Keyboard seek (left/right arrows on progress bar)
            progressContainer.addEventListener('keydown', function(e) {
                if (e.code === 'ArrowLeft') {
                    e.preventDefault();
                    audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 5);
                } else if (e.code === 'ArrowRight') {
                    e.preventDefault();
                    audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + 5);
                }
            });
            
            // Volume control
            volumeSlider.addEventListener('input', function() {
                audioPlayer.volume = volumeSlider.value;
                audioPlayer.muted = false;
                updateVolumeIcon();
                updateVolumePercentage();
            });
            
            // Mute toggle
            muteButton.addEventListener('click', function() {
                audioPlayer.muted = !audioPlayer.muted;
                updateVolumeIcon();
            });
            
            function updateVolumeIcon() {
                if (audioPlayer.muted || audioPlayer.volume === 0) {
                    muteButton.innerHTML = volumeOffIcon;
                    muteButton.setAttribute('aria-label', 'Unmute');
                } else {
                    muteButton.innerHTML = volumeOnIcon;
                    muteButton.setAttribute('aria-label', 'Mute');
                }
            }
            
            function updateVolumePercentage() {
                const percent = Math.round(audioPlayer.volume * 100);
                volumePercentage.textContent = percent + '%';
            }
            
            // Handle audio ended
            audioPlayer.addEventListener('ended', function() {
                playButton.innerHTML = playIcon;
                playButton.setAttribute('aria-label', 'Play');
                progressBar.style.width = '0%';
                currentTimeDisplay.textContent = '0:00';
            });
            
            // Error handling
            audioPlayer.addEventListener('error', function(e) {
                const error = audioPlayer.error;
                let message = 'Playback error occurred';
                
                if (error) {
                    switch (error.code) {
                        case error.MEDIA_ERR_ABORTED:
                            message = 'Playback was aborted';
                            break;
                        case error.MEDIA_ERR_NETWORK:
                            message = 'Network error occurred';
                            break;
                        case error.MEDIA_ERR_DECODE:
                            message = 'Audio decoding failed';
                            break;
                        case error.MEDIA_ERR_SRC_NOT_SUPPORTED:
                            message = 'Audio format not supported';
                            break;
                    }
                }
                
                showError(message);
            });
            
            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
                console.error('Audio player error:', message);
            }
            
            // Global keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Don't trigger if user is typing in an input
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }
                
                switch (e.code) {
                    case 'Space':
                        e.preventDefault();
                        togglePlayPause();
                        break;
                    case 'KeyM':
                        e.preventDefault();
                        muteButton.click();
                        break;
                    case 'ArrowLeft':
                        e.preventDefault();
                        audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 5);
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + 5);
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        audioPlayer.volume = Math.min(1, audioPlayer.volume + 0.1);
                        volumeSlider.value = audioPlayer.volume;
                        updateVolumePercentage();
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        audioPlayer.volume = Math.max(0, audioPlayer.volume - 0.1);
                        volumeSlider.value = audioPlayer.volume;
                        updateVolumePercentage();
                        break;
                }
            });
            
            // Social Sharing Functionality
            const shareButton = document.getElementById('share-button');
            const shareMenu = document.getElementById('share-menu');
            const shareOptions = document.querySelectorAll('.share-option');
            
            // Toggle share menu
            shareButton.addEventListener('click', function(e) {
                e.stopPropagation();
                const isVisible = shareMenu.style.display !== 'none';
                shareMenu.style.display = isVisible ? 'none' : 'block';
                if (!isVisible) {
                    shareMenu.setAttribute('aria-expanded', 'true');
                } else {
                    shareMenu.setAttribute('aria-expanded', 'false');
                }
            });
            
            // Close share menu when clicking outside
            document.addEventListener('click', function(e) {
                if (!shareButton.contains(e.target) && !shareMenu.contains(e.target)) {
                    shareMenu.style.display = 'none';
                    shareMenu.setAttribute('aria-expanded', 'false');
                }
            });
            
            // Handle share option clicks
            shareOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const platform = this.getAttribute('data-platform');
                    const trackTitle = '{{ metadata.Product.Title }}';
                    const trackArtist = '{{ metadata.Product.Artist }}';
                    const trackUrl = window.location.href;
                    const shareText = `Check out "${trackTitle}" by ${trackArtist} on Loist Music Library!`;
                    
                    let shareUrl = '';
                    
                    switch (platform) {
                        case 'twitter':
                            shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(trackUrl)}`;
                            break;
                        case 'facebook':
                            shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(trackUrl)}`;
                            break;
                        case 'linkedin':
                            shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(trackUrl)}`;
                            break;
                        case 'copy':
                            // Copy to clipboard
                            if (navigator.clipboard && navigator.clipboard.writeText) {
                                navigator.clipboard.writeText(trackUrl).then(() => {
                                    showTemporaryMessage('Link copied to clipboard!');
                                }).catch(() => {
                                    fallbackCopyToClipboard(trackUrl);
                                });
                            } else {
                                fallbackCopyToClipboard(trackUrl);
                            }
                            shareMenu.style.display = 'none';
                            shareMenu.setAttribute('aria-expanded', 'false');
                            return;
                    }
                    
                    if (shareUrl) {
                        window.open(shareUrl, '_blank', 'width=600,height=400');
                        shareMenu.style.display = 'none';
                        shareMenu.setAttribute('aria-expanded', 'false');
                    }
                });
            });
            
            // Fallback copy to clipboard for older browsers
            function fallbackCopyToClipboard(text) {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    showTemporaryMessage('Link copied to clipboard!');
                } catch (err) {
                    showTemporaryMessage('Unable to copy link. Please copy manually: ' + text);
                }
                
                document.body.removeChild(textArea);
            }
            
            // Show temporary message
            function showTemporaryMessage(message) {
                const existingMessage = document.querySelector('.temp-message');
                if (existingMessage) {
                    existingMessage.remove();
                }
                
                const tempMessage = document.createElement('div');
                tempMessage.className = 'temp-message';
                tempMessage.textContent = message;
                tempMessage.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: var(--primary-color);
                    color: white;
                    padding: 12px 16px;
                    border-radius: 6px;
                    box-shadow: 0 4px 20px var(--shadow);
                    z-index: 10000;
                    font-size: 14px;
                    animation: slideIn 0.3s ease;
                `;
                
                // Add animation keyframes
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
                
                document.body.appendChild(tempMessage);
                
                setTimeout(() => {
                    tempMessage.style.animation = 'slideIn 0.3s ease reverse';
                    setTimeout(() => {
                        if (tempMessage.parentNode) {
                            tempMessage.parentNode.removeChild(tempMessage);
                        }
                    }, 300);
                }, 2000);
            }
            
            // Initialize
            updateVolumeIcon();
            updateVolumePercentage();
            
            // Log player ready
            console.log('Music player initialized for: {{ metadata.Product.Title }}');
        })();
    </script>
</body>
</html>



