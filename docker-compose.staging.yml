version: '3.9'

services:
  # Cloud SQL Proxy for staging database access
  cloudsql-proxy:
    image: gcr.io/cloudsql-docker/gce-proxy:1.33.8
    container_name: cloudsql-proxy-staging
    command:
      - "/cloud_sql_proxy"
      - "-instances=${DB_CONNECTION_NAME}=tcp:0.0.0.0:5432"
      - "-credential_file=/secrets/cloudsql/credentials.json"
    volumes:
      - ./service-account-key.json:/secrets/cloudsql/credentials.json:ro
    ports:
      - "5432:5432"
    restart: unless-stopped
    networks:
      - staging-network
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "5432"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Music Library MCP Server - Staging Configuration
  mcp-server-staging:
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime
    container_name: music-library-mcp-staging
    ports:
      - "8081:8080"  # Different port to avoid conflicts with local dev
    environment:
      # Server Configuration - Staging
      - SERVER_NAME=Music Library MCP - Staging Environment
      - SERVER_VERSION=0.1.0-staging
      - SERVER_HOST=0.0.0.0
      - SERVER_PORT=8080
      - SERVER_TRANSPORT=http

      # Logging - More verbose for staging
      - LOG_LEVEL=DEBUG
      - LOG_FORMAT=json  # Structured logging for staging

      # Authentication - Disabled for staging testing
      - AUTH_ENABLED=false
      - BEARER_TOKEN=staging-test-token

      # CORS - Permissive for staging testing
      - ENABLE_CORS=true
      - CORS_ORIGINS=*
      - CORS_ALLOW_CREDENTIALS=true

      # Feature Flags
      - ENABLE_HEALTHCHECK=true

      # Database Configuration - Connect via Cloud SQL Proxy
      - DB_HOST=cloudsql-proxy
      - DB_PORT=5432
      - DB_NAME=loist_mvp_staging
      - DB_USER=music_library_user
      - DB_PASSWORD=${DB_PASSWORD}
      - DATABASE_URL=postgresql://music_library_user:${DB_PASSWORD}@cloudsql-proxy:5432/loist_mvp_staging
      - DB_CONNECTION_NAME=${DB_CONNECTION_NAME}

      # Google Cloud Storage Configuration - Staging Bucket
      - GOOGLE_APPLICATION_CREDENTIALS=/app/service-account-key.json
      - GCS_BUCKET_NAME=${GCS_BUCKET_NAME_STAGING:-loist-music-library-staging-audio}
      - GCS_PROJECT_ID=${GCS_PROJECT_ID:-loist-music-library}

      # Embed Configuration - Staging Domain
      - EMBED_BASE_URL=https://staging.loist.io

      # Environment Identification
      - ENVIRONMENT=staging
      - NODE_ENV=staging

      # Python Configuration
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1

      # Staging-specific settings
      - DEBUG=true
      - TEST_MODE=true

    volumes:
      # Mount source code for live development (hot reload)
      - ./src:/app/src:ro
      # Mount database migrations and config
      - ./database:/app/database:ro
      # Mount templates for embed page rendering
      - ./templates:/app/templates:ro
      # Mount storage for any local file operations
      - ./storage:/app/storage
      # Mount GCS service account credentials
      - ./service-account-key.json:/app/service-account-key.json:ro

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.path.insert(0, 'src'); from server import mcp; print('staging-healthy')"]
      interval: 30s
      timeout: 15s
      retries: 3
      start_period: 15s

    depends_on:
      cloudsql-proxy:
        condition: service_healthy

    networks:
      - staging-network

  # Optional: PostgreSQL for local staging testing (alternative to Cloud SQL)
  # Uncomment if you want to test with local PostgreSQL instead of Cloud SQL
  # postgres-staging:
  #   image: postgres:16-alpine
  #   container_name: music-library-db-staging
  #   environment:
  #     - POSTGRES_DB=loist_mvp_staging
  #     - POSTGRES_USER=music_library_user
  #     - POSTGRES_PASSWORD=staging_password
  #   ports:
  #     - "5433:5432"  # Different port to avoid conflicts
  #   volumes:
  #     - postgres_staging_data:/var/lib/postgresql/data
  #   networks:
  #     - staging-network

networks:
  staging-network:
    driver: bridge
    name: staging-network

# Volumes for persistent staging data
volumes:
  postgres_staging_data:
