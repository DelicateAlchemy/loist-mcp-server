name: Cloud Build Trigger

on:
  push:
    branches: [ main, dev ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  PROJECT_ID: loist-music-library

jobs:
  trigger-cloud-build:
    name: Trigger Cloud Build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      id: auth
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCLOUD_SERVICE_KEY }}

    - name: Set up Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        version: 'latest'

    - name: Trigger Cloud Build
      run: |
        echo "üîÑ Triggering Google Cloud Build..."

        # Determine which build configuration to use
        if [ "${{ github.ref }}" = "refs/heads/main" ] || [ "${{ github.event.inputs.environment }}" = "production" ]; then
          BUILD_CONFIG="cloudbuild.yaml"
          BUILD_TRIGGER="main-deployment"
          echo "üèóÔ∏è Using production build configuration"
        else
          BUILD_CONFIG="cloudbuild-staging.yaml"
          BUILD_TRIGGER="staging-deployment"
          echo "üèóÔ∏è Using staging build configuration"
        fi

        # Trigger Cloud Build with current commit
        gcloud builds submit \
          --config=${BUILD_CONFIG} \
          --substitutions=_COMMIT_SHA=${{ github.sha }},_BRANCH=${{ github.ref_name }} \
          --project=${{ env.PROJECT_ID }} \
          --quiet

        echo "‚úÖ Cloud Build triggered successfully"
        echo "üìä Build details:"
        echo "  - Commit: ${{ github.sha }}"
        echo "  - Branch: ${{ github.ref_name }}"
        echo "  - Config: ${BUILD_CONFIG}"
        echo "  - Project: ${{ env.PROJECT_ID }}"

  notify:
    name: Notify Build Status
    runs-on: ubuntu-latest
    needs: trigger-cloud-build
    if: always()

    steps:
    - name: Build Success Notification
      if: needs.trigger-cloud-build.result == 'success'
      run: |
        echo "‚úÖ Google Cloud Build triggered successfully!"
        echo "Check the Google Cloud Build console for detailed build progress."

    - name: Build Failure Notification
      if: needs.trigger-cloud-build.result == 'failure'
      run: |
        echo "‚ùå Failed to trigger Google Cloud Build!"
        echo "Please check the GitHub Actions logs and try again."
        exit 1
